---
# Reset and update the repository
- name: Reset git repository to clean state
  shell: |
    cd /opt/kindle-automator
    git reset --hard HEAD
  args:
    executable: /bin/bash
  register: git_reset

- name: Pull latest changes
  git:
    repo: "{{ kindle_repo_url }}"
    dest: /opt/kindle-automator
    update: yes
    version: "{{ kindle_repo_branch | default('main') }}"
    key_file: /opt/keys/deploy_key
    accept_hostkey: yes
  register: git_pull

# Update Python dependencies if requirements.txt changed
- name: Update Python dependencies if requirements.txt changed
  shell: |
    cd /opt/kindle-automator
    uv pip install -r requirements.txt
  args:
    executable: /bin/bash
  when: git_pull.changed

# Run database migrations
- name: Run database migrations
  shell: |
    cd /opt/kindle-automator
    ENVIRONMENT="{% if 'staging' in inventory_hostname %}staging{% else %}prod{% endif %}" uv run dotenv run alembic upgrade head
  args:
    executable: /bin/bash
  register: db_migration
  changed_when: "'Running upgrade' in db_migration.stdout"

- name: Display migration output
  debug:
    msg: "{{ db_migration.stdout_lines }}"
  when: db_migration.changed

# Always trigger handlers to restart service
- name: Restart kindle-automator service
  command: /bin/true
  changed_when: true
  notify:
    - restart kindle-automator
