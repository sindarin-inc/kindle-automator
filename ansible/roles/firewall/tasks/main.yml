---
- name: Install UFW firewall
  apt:
    name: ufw
    state: present
    update_cache: yes

- name: Disable IPv6 in UFW to avoid ip6tables issues
  lineinfile:
    path: /etc/default/ufw
    regexp: '^IPV6='
    line: 'IPV6=no'
    backup: yes

- name: Set UFW defaults
  ufw:
    direction: "{{ item.direction }}"
    policy: "{{ item.policy }}"
  loop:
    - { direction: 'incoming', policy: 'deny' }
    - { direction: 'outgoing', policy: 'allow' }

- name: Allow SSH from anywhere (be careful!)
  ufw:
    rule: allow
    port: 22
    proto: tcp

- name: Allow HTTP traffic
  ufw:
    rule: allow
    port: 80
    proto: tcp
  when: "'db' not in group_names"

- name: Allow HTTPS traffic
  ufw:
    rule: allow
    port: 443
    proto: tcp
  when: "'db' not in group_names"

- name: Allow Flask server port
  ufw:
    rule: allow
    port: 4098
    proto: tcp
  when: "'db' not in group_names"

# PostgreSQL firewall rules are now handled in the postgres role

- name: Enable UFW
  ufw:
    state: enabled
    
- name: Reload UFW
  command: ufw reload
  changed_when: false