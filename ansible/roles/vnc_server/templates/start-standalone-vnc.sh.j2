#!/bin/bash
# Standalone script to set up Xvfb with app clipping for Kindle Automator
# This script handles multiple VNC instances with different display numbers

# Configuration
NUM_INSTANCES={{ vnc_instances|default(2) }}
BASE_DISPLAY=99
BASE_VNC_PORT=5999
VNC_PASSWORD="{{ vnc_password|default('changeme') }}"
VNC_RESOLUTION="{{ vnc_resolution|default('360x640x24') }}"
APP_SIZE="360x640"
LOG_DIR="/var/log"

# Kill and clean up everything
echo "Killing all existing processes..."
pkill -9 -f "Xvfb|x11vnc|websockify" || true

# Clean lock files
echo "Cleaning lock files..."
rm -f /tmp/.X*-lock || true
rm -f /tmp/.X11-unix/X* || true
mkdir -p /tmp/.X11-unix
chmod 1777 /tmp/.X11-unix

# Create VNC password file
mkdir -p /home/{{ ansible_user }}/.vnc
echo "$VNC_PASSWORD" > /home/{{ ansible_user }}/.vnc/passwd
chmod 600 /home/{{ ansible_user }}/.vnc/passwd

# Set up multiple VNC instances
for i in $(seq 1 $NUM_INSTANCES); do
  DISPLAY_NUM=$((BASE_DISPLAY + i))
  VNC_PORT=$((BASE_VNC_PORT + i))
  LOG_FILE="${LOG_DIR}/xvfb-${i}.log"
  VNC_LOG_FILE="${LOG_DIR}/x11vnc-${i}.log"
  NOVNC_PORT=$((6080 + i))

  # Start Xvfb
  echo "Starting Xvfb on display :$DISPLAY_NUM..."
  /usr/bin/Xvfb :$DISPLAY_NUM -screen 0 800x600x24 -ac +extension GLX +render -noreset > "$LOG_FILE" 2>&1 &
  sleep 2

  # Calculate clip position (center app in the display)
  X_POS=$((400 - 360/2))
  Y_POS=$((300 - 640/2))
  CLIP_REGION="${APP_SIZE}+${X_POS}+${Y_POS}"

  # Start x11vnc with clipping
  echo "Starting x11vnc on display :$DISPLAY_NUM with app clipping..."
  /usr/bin/x11vnc -display :$DISPLAY_NUM -forever -shared -rfbport $VNC_PORT \
    -rfbauth /home/{{ ansible_user }}/.vnc/passwd -clip "$CLIP_REGION" \
    -cursor arrow -noxdamage -noxfixes -noipv6 \
    -desktop "Kindle App ($i)" -o "$VNC_LOG_FILE" -bg

  # Start noVNC websockify
  echo "Starting noVNC websockify for VNC on port $VNC_PORT..."
  /usr/bin/websockify --web=/opt/novnc $NOVNC_PORT localhost:$VNC_PORT > "${LOG_DIR}/novnc-${i}.log" 2>&1 &

  echo "Instance $i setup complete:"
  echo "  - Xvfb running on display :$DISPLAY_NUM"
  echo "  - VNC server running on port $VNC_PORT"
  echo "  - noVNC websocket running on port $NOVNC_PORT"
done

# Create instance mapping JSON file
echo "Creating instance mapping file..."
cat > /opt/vnc_instance_map.json << 'EOF'
{
  "instances": [
{% for i in range(1, vnc_instances + 1) %}
    {
      "id": {{ i }},
      "display": {{ 99 + i }},
      "vnc_port": {{ 5999 + i }},
      "novnc_port": {{ 6080 + i }},
      "launcher": "/usr/local/bin/vnc-emulator-launcher-{{ i }}.sh",
      "assigned_profile": null
    }{% if not loop.last %},{% endif %}
{% endfor %}
  ],
  "version": 1
}
EOF

echo "All VNC instances started successfully"
echo "Use 'curl http://localhost:4098/profiles' to see available VNC instances"

# Keep the script running to prevent systemd service from exiting
# The sleep is interrupted if the script receives a signal
while true; do
  sleep 3600 & wait $!
done
