[Unit]
Description=X Virtual Frame Buffer %i
After=network.target

[Service]
User={{ ansible_user }}
# Add cleanup before starting Xvfb
ExecStartPre=/bin/sh -c 'pkill -f "Xvfb :%i" || true; rm -f /tmp/.X%i-lock /tmp/.X11-unix/X%i'
ExecStart=/usr/bin/Xvfb :%i -screen 0 {{ vnc_resolution|default('1280x800x24') }} -ac +extension GLX +render -noreset
Restart=on-failure
# Clean up when stopped
ExecStopPost=/bin/sh -c 'rm -f /tmp/.X%i-lock /tmp/.X11-unix/X%i'

[Install]
WantedBy=multi-user.target