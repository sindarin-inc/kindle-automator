#!/bin/bash
#
# Helper script to launch Android emulator with VNC display support
# This script ensures emulators are always tied to specific screens based on profile
#

# Directory where Android SDK is installed
ANDROID_HOME={{ android_home|default('/opt/android-sdk') }}

# Extra options for VNC display operation
EMULATOR_OPTS="-gpu swiftshader_indirect -no-boot-anim"

# VNC instance mapping file
VNC_MAPPING_FILE="/opt/kindle-automator/vnc-instance-mapping.json"

# Function to ensure the mapping file exists
ensure_mapping_file() {
  if [ ! -f "$VNC_MAPPING_FILE" ]; then
    echo "{}" > "$VNC_MAPPING_FILE"
    chmod 666 "$VNC_MAPPING_FILE"
  fi
}

# Extract the email from AVD name
extract_email() {
  local avd_name="$1"
  # Check if AVD name contains email pattern
  if [[ "$avd_name" =~ .*_([^_]+@[^_]+\.[^_]+)_.* ]]; then
    echo "${BASH_REMATCH[1]}"
  else
    echo ""
  fi
}

# Get AVD name from command line args
get_avd_name() {
  local args=("$@")
  for ((i=0; i<${#args[@]}; i++)); do
    if [ "${args[$i]}" = "-avd" ] && [ $((i+1)) -lt ${#args[@]} ]; then
      echo "${args[$i+1]}"
      return 0
    fi
  done
  echo ""
}

# Find or assign VNC instance for profile
find_or_assign_vnc_instance() {
  local email="$1"
  
  ensure_mapping_file
  
  # Check if this email already has an assigned VNC instance
  if [ -n "$email" ] && [ -f "$VNC_MAPPING_FILE" ]; then
    local assigned_instance
    assigned_instance=$(jq -r --arg email "$email" '.[$email].instance // empty' "$VNC_MAPPING_FILE")
    
    if [ -n "$assigned_instance" ]; then
      echo "$assigned_instance"
      return 0
    fi
  fi
  
  # No assigned instance, find the first available one (1-10)
  local used_instances
  used_instances=$(jq -r '.[] | .instance' "$VNC_MAPPING_FILE" 2>/dev/null | sort)
  
  for i in {1..10}; do
    if ! echo "$used_instances" | grep -q "^$i$"; then
      # This instance is available
      if [ -n "$email" ]; then
        # Create a temporary file for the update
        local temp_file
        temp_file=$(mktemp)
        
        # Add mapping for this email to the available instance
        jq --arg email "$email" --arg instance "$i" \
          '.[$email] = {"instance": $instance|tonumber, "display": $instance|tonumber, "port": (5900+$instance|tonumber)}' \
          "$VNC_MAPPING_FILE" > "$temp_file"
        
        # Replace the original file with the updated one
        mv "$temp_file" "$VNC_MAPPING_FILE"
        chmod 666 "$VNC_MAPPING_FILE"
      fi
      echo "$i"
      return 0
    fi
  done
  
  # No available instances
  echo "1" # Default to instance 1 if no available instances
  return 1
}

# Start VNC service for a specific display if not already running
ensure_vnc_running() {
  local display_num="$1"
  
  # Check if Xvfb is running for this display
  if ! ps aux | grep -v grep | grep -q "Xvfb :${display_num}"; then
    systemctl start xvfb@${display_num}.service
    sleep 1
  fi
  
  # Check if x11vnc is running for this display
  if ! ps aux | grep -v grep | grep -q "x11vnc.*:${display_num}"; then
    systemctl start vnc@${display_num}.service
    sleep 1
  fi
}

# Main script execution starts here

# Get AVD name from arguments
AVD_NAME=$(get_avd_name "$@")

if [ -z "$AVD_NAME" ]; then
  echo "Error: No AVD name specified. Please use -avd <name> argument."
  exit 1
fi

# Extract email from AVD name
EMAIL=$(extract_email "$AVD_NAME")

# If no email found, still proceed but with default instance
if [ -z "$EMAIL" ]; then
  echo "Warning: Could not extract email from AVD name, using default VNC instance."
  EMAIL="default"
fi

# Find or assign VNC instance for this profile
INSTANCE=$(find_or_assign_vnc_instance "$EMAIL")
DISPLAY_NUM=$INSTANCE

# Set display environment variable
export DISPLAY=:${DISPLAY_NUM}

# Ensure VNC is running for this display
ensure_vnc_running "$DISPLAY_NUM"

echo "Launching emulator for profile $EMAIL on display :$DISPLAY_NUM"

# Execute the emulator command with the virtual display
"$ANDROID_HOME/emulator/emulator" $EMULATOR_OPTS "$@"