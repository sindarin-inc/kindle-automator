---
- name: Install VNC server and dependencies
  apt:
    name:
      - xvfb
      - x11vnc
      - openbox
      - xorg
      - dbus-x11
      - xauth
      - expect
      - nodejs
      - npm
      - git
    state: present
    update_cache: yes

- name: Install noVNC web-based VNC client
  git:
    repo: https://github.com/novnc/noVNC.git
    dest: /opt/novnc
    version: master
    
- name: Copy noVNC configuration file for mobile embedding
  copy:
    src: novnc-config.js
    dest: /opt/novnc/app/config.js
    mode: '0644'
    
- name: Create mobile-optimized HTML file for WebView embedding
  copy:
    content: |
      <!DOCTYPE html>
      <html>
      <head>
          <meta charset="utf-8">
          <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
          <title>Kindle Captcha Solver</title>
          <link rel="stylesheet" href="app/styles/lite.css">
          <script type="module" crossorigin="anonymous">
              // Auto-connect to VNC
              window.addEventListener('load', function() {
                  let urlParams = new URLSearchParams(window.location.search);
                  let defaultHost = window.location.hostname;
                  let defaultPort = '5900';
                  let password = urlParams.get('password') || '';
                  
                  // Get connection parameters
                  let host = urlParams.get('host') || defaultHost;
                  let port = urlParams.get('port') || defaultPort;
                  let path = "websockify";
                  let autoconnect = urlParams.get('autoconnect') !== 'false';
                  let resize = urlParams.get('resize') || 'scale';
                  
                  // Configure connection
                  let rfb;
                  const rfbConfig = {
                      credentials: {
                          password: password
                      },
                      wsProtocols: ['binary'],
                      showDotCursor: true,
                      autoconnect: autoconnect,
                      scaleViewport: resize === 'scale',
                      resizeSession: resize === 'remote',
                      clipViewport: false,
                      quality: 6,
                      compressionLevel: 2,
                      repeaterId: '',
                      shared: true,
                      showContextMenu: true,
                      viewOnly: false
                  };
                  
                  // Connect to WebSocket
                  const wsUrl = `ws://${host}:6080/${path}`;
                  import('./app/ui.js').then((ui) => {
                      rfb = ui.connect(wsUrl, rfbConfig);
                  });
              });
          </script>
          <style>
              body {
                  margin: 0;
                  padding: 0;
                  height: 100vh;
                  background-color: black;
              }
              #screen {
                  width: 100vw;
                  height: 100vh;
                  display: flex;
                  align-items: center;
                  justify-content: center;
              }
              canvas {
                  max-width: 100%;
                  max-height: 100%;
                  object-fit: contain;
              }
          </style>
      </head>
      <body>
          <div id="screen">
              <!-- VNC display will be inserted here -->
          </div>
      </body>
      </html>
    dest: /opt/novnc/kindle_captcha.html
    mode: '0644'
    
- name: Install websockify for noVNC
  apt:
    name: 
      - python3-websockify
      - python3-numpy  # Required by websockify
    state: present
    
- name: Create log file for x11vnc
  file:
    path: /var/log/x11vnc.log
    state: touch
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0644'

- name: Create VNC server configuration directory
  file:
    path: /home/{{ ansible_user }}/.vnc
    state: directory
    mode: '0755'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create simple VNC password file
  copy:
    dest: /home/{{ ansible_user }}/.vnc/passwd
    content: "{{ vnc_password }}"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: '0600'
  no_log: true

- name: Create Xvfb service file
  template:
    src: xvfb.service.j2
    dest: /etc/systemd/system/xvfb.service
    mode: '0644'
  notify: restart xvfb

- name: Create VNC service file
  template:
    src: vnc.service.j2
    dest: /etc/systemd/system/vnc.service
    mode: '0644'
  notify: restart vnc
  
- name: Create noVNC web service file
  template:
    src: novnc.service.j2
    dest: /etc/systemd/system/novnc.service
    mode: '0644'
  notify: restart novnc

- name: Create helper script for emulator with VNC display
  template:
    src: vnc-emulator-launcher.sh.j2
    dest: /usr/local/bin/vnc-emulator-launcher.sh
    mode: '0755'

- name: Enable and start Xvfb service
  systemd:
    name: xvfb
    enabled: yes
    state: started
    daemon_reload: yes

- name: Enable and start VNC service
  systemd:
    name: vnc
    enabled: yes
    state: started
    daemon_reload: yes
    
- name: Enable and start noVNC service
  systemd:
    name: novnc
    enabled: yes
    state: started
    daemon_reload: yes
    
- name: Copy AVD profile manager patch script
  copy:
    src: patch-avd-profile-manager.py
    dest: /usr/local/bin/patch-avd-profile-manager.py
    mode: '0755'
    
- name: Add instructions to README
  copy:
    content: |
      # VNC Setup for Kindle Automator
      
      The VNC server has been set up to allow remote viewing of the Android emulator.
      
      ## Connection Options
      
      ### Option 1: Web Browser (Recommended for mobile devices)
      Access the emulator through a web browser at:
      ```
      http://{{ ansible_host }}:6080/vnc.html
      ```
      
      This works on any device with a modern web browser (iOS, Android, desktop).
      Password: {{ vnc_password }}
      
      ### Option 2: Mobile-Optimized Interface
      For the best mobile experience, use our custom interface:
      ```
      http://{{ ansible_host }}:6080/kindle_captcha.html?password={{ vnc_password }}
      ```
      
      This is designed specifically for captcha solving with:
      - Auto-connection
      - Mobile-optimized UI
      - Responsive scaling
      
      ### Option 3: Native VNC Client
      Connect using any VNC client:
      - Host: {{ ansible_host }}
      - Port: 5900
      - Password: {{ vnc_password }}
      
      ## Mobile App Integration
      
      To embed the VNC viewer in your mobile app, use a WebView with this URL:
      ```
      http://{{ ansible_host }}:6080/kindle_captcha.html?password={{ vnc_password }}&autoconnect=true
      ```
      
      This provides a lightweight VNC viewer perfect for embedding in mobile applications.
      
      ### WebView Implementation (Example)
      
      ```java
      // Android example
      WebView webView = findViewById(R.id.webView);
      webView.getSettings().setJavaScriptEnabled(true);
      webView.loadUrl("http://{{ ansible_host }}:6080/kindle_captcha.html?password={{ vnc_password }}&autoconnect=true");
      ```
      
      ```swift
      // iOS example
      let webView = WKWebView()
      let url = URL(string: "http://{{ ansible_host }}:6080/kindle_captcha.html?password={{ vnc_password }}&autoconnect=true")!
      webView.load(URLRequest(url: url))
      ```
    dest: /home/{{ ansible_user }}/VNC_SETUP.md
    mode: '0644'
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"