---
- name: Install VNC server and dependencies
  apt:
    name:
      - xvfb
      - x11vnc
      - openbox
      - xorg
      - dbus-x11
      - xauth
      - expect
      - nodejs
      - npm
      - git
      - x11-utils  # Provides xwininfo, xdpyinfo
      - jq          # Used for parsing JSON in scripts
    state: present
    update_cache: yes


# Authentication managed by the Flask server's /vnc endpoint

- name: Create log files for x11vnc instances
  file:
    path: "/var/log/x11vnc-{{ item }}.log"
    state: touch
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  loop: "{{ range(1, vnc_instances + 1)|list }}"

- name: Create VNC server configuration directory
  file:
    path: /home/{{ ansible_user }}/.vnc
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

# Create a properly encoded VNC password file using x11vnc utility
- name: Create keys directory
  file:
    path: /opt/keys
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Check if VNC password file exists
  stat:
    path: /opt/keys/vnc.pass
  register: vnc_pass_file

- name: Create VNC password file using x11vnc -storepasswd
  shell: |
    x11vnc -storepasswd {{ vnc_password }} /opt/keys/vnc.pass
  args:
    creates: /opt/keys/vnc.pass
  when: not vnc_pass_file.stat.exists
  no_log: true

- name: Set permissions on VNC password file
  file:
    path: /opt/keys/vnc.pass
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"



- name: Create VNC instance mapping file
  template:
    src: vnc_instance_map.json.j2
    dest: /opt/vnc_instance_map.json
    mode: "0644"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

# Remove legacy systemd services that are now managed by Python
- name: Stop and disable deprecated systemd services
  systemd:
    name: "{{ item }}"
    state: stopped
    enabled: no
  loop:
    - "xvfb@*.service"
    - "vnc@*.service" 
  ignore_errors: yes

- name: Remove deprecated systemd service files
  file:
    path: "/etc/systemd/system/{{ item }}"
    state: absent
  loop:
    - "xvfb@.service"
    - "vnc@.service"
  notify: reload systemd

# Create default instance mapping file for initial VNC instance management
- name: Create VNC instance mapping directory
  file:
    path: /opt/kindle-automator
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Create initial empty VNC instance mapping file
  copy:
    content: "{}"
    dest: /opt/kindle-automator/vnc-instance-mapping.json
    mode: "0666"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
  when: not ansible_check_mode

- name: Add instructions to README
  copy:
    content: |
      # Multi-Instance VNC Setup for Kindle Automator

      The VNC server has been set up with {{ vnc_instances }} instances to allow multiple emulators to run simultaneously.

      ## Display and Port Mappings

      Each emulator runs on its own virtual display with its own VNC server:

      {% for i in range(1, vnc_instances + 1) %}
      - Instance {{ i }}: 
          - Display :{{ i }}
          - VNC Port: {{ 5900 + i }}
      {% endfor %}

      ## Connection Options

      ### Option 1: Native VNC Client (Recommended)
      Connect directly to your profile's assigned VNC server:
      - Host: {{ ansible_host }}
      - Port: Assigned by the system (5901-5908)
      - Password: {{ vnc_password }}
      
      **Important**: The VNC server is configured to show the Kindle app window (360x640 pixels).
      This makes it perfect for viewing on mobile VNC clients.
      
      This works on any VNC client (iOS, Android, desktop).
      Password: {{ vnc_password }}

      ### Option 2: Port Lookup
      To find which port your profile is using:
      ```
      curl http://{{ ansible_host }}:4098/profiles?email=your_profile_email@example.com
      ```

      This endpoint returns all the necessary connection details including:
      - VNC port
      - Display number
      - Emulator ID

      ## Mobile App Integration

      For mobile app integration, you can use any VNC client library:
      
      - Android: Use [AndroidVncClient](https://github.com/antlersoft/android-vnc-viewer)
      - iOS: Use [FMVNC](https://github.com/FancyVCE/FMVNC) or other native VNC libraries
      
      Example configuration:
      ```
      host: {{ ansible_host }}
      port: [port from profiles endpoint]
      password: {{ vnc_password }}
      ```
      
      The port for each profile can be retrieved from the profiles endpoint as shown above.
    dest: /home/{{ ansible_user }}/VNC_SETUP.md
    mode: "0644"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
