---
- name: Install VNC server and dependencies
  apt:
    name:
      - xvfb
      - x11vnc
      - openbox
      - xorg
      - dbus-x11
      - xauth
      - expect
      - nodejs
      - npm
      - git
      - x11-utils  # Provides xwininfo, xdpyinfo
      - jq          # Used for parsing JSON in scripts
    state: present
    update_cache: yes


# Authentication managed by the Flask server's /vnc endpoint

- name: Create log files for x11vnc instances
  file:
    path: "/var/log/x11vnc-{{ item }}.log"
    state: touch
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0644"
  loop: "{{ range(1, vnc_instances + 1)|list }}"

- name: Create VNC server configuration directory
  file:
    path: /home/{{ ansible_user }}/.vnc
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

# Create a properly encoded VNC password file using x11vnc utility
- name: Create keys directory
  file:
    path: /opt/keys
    state: directory
    mode: "0755"
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"

- name: Check if VNC password file exists
  stat:
    path: /opt/keys/vnc.pass
  register: vnc_pass_file

- name: Create VNC password file using x11vnc -storepasswd
  shell: |
    x11vnc -storepasswd {{ vnc_password }} /opt/keys/vnc.pass
  args:
    creates: /opt/keys/vnc.pass
  when: not vnc_pass_file.stat.exists
  no_log: true

- name: Set permissions on VNC password file
  file:
    path: /opt/keys/vnc.pass
    owner: "{{ ansible_user }}"
    group: "{{ ansible_user }}"
    mode: "0600"
