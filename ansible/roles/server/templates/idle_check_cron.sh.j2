#!/bin/bash
# Idle check cron script for Kindle Automator
# Managed by Ansible - do not edit directly

# Configuration
SERVER_URL="{{ kindle_automator_url | default('http://localhost:4098') }}"
IDLE_TIMEOUT_MINUTES="{{ idle_timeout_minutes | default(30) }}"
LOG_FILE="/opt/kindle-automator/logs/idle-check.log"

# Ensure log directory exists
mkdir -p "$(dirname "$LOG_FILE")"

# Get current timestamp
TIMESTAMP=$(date "+%Y-%m-%d %H:%M:%S")

echo "[$TIMESTAMP] Running idle check..." >> "$LOG_FILE"

# Call the idle check endpoint
RESPONSE=$(curl -s -X POST "$SERVER_URL/idle-check" \
  -H "Content-Type: application/json" \
  -d "{\"idle_timeout_minutes\": $IDLE_TIMEOUT_MINUTES}")

# Log the response
echo "[$TIMESTAMP] Response: $RESPONSE" >> "$LOG_FILE"

# Rotate log file if it gets too large (over 1MB)
if [ -f "$LOG_FILE" ]; then
    FILE_SIZE=$(stat -c%s "$LOG_FILE" 2>/dev/null || stat -f%z "$LOG_FILE" 2>/dev/null)
    if [ "$FILE_SIZE" -gt 1048576 ]; then
        mv "$LOG_FILE" "$LOG_FILE.old"
        echo "[$TIMESTAMP] Log rotated" > "$LOG_FILE"
    fi
fi