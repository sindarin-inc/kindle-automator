---
# Install required system packages
- name: Install required packages
  apt:
    name:
      - git
      - python3
      - python3-pip
      - python3-venv
      - libffi-dev
      - libssl-dev
      - build-essential
      - nodejs
      - npm
      - unzip
    state: present
    update_cache: yes

# Create app directory
- name: Create application directory
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - /opt/keys

# Create public deploy key for GitHub
- name: Copy public deploy key for GitHub
  copy:
    src: files/deploy_key
    dest: /opt/keys/deploy_key
    mode: "0400"
  register: deploy_key

# Clean and re-clone repository
- name: Check repository state
  stat:
    path: /opt/kindle-automator/requirements.txt
  register: repo_files

# Backup .env.prod if it exists
- name: Backup .env.prod
  shell: |
    if [ -f /opt/kindle-automator/.env.prod ]; then
      cp /opt/kindle-automator/.env.prod /tmp/.env.prod.backup
    fi
  changed_when: false

# Backup existing env and venv
- name: Backup essential files
  shell: |
    mkdir -p /tmp/kindle-temp
    if [ -d /opt/kindle-automator/venv ]; then
      mv /opt/kindle-automator/venv /tmp/kindle-temp/
    fi
  changed_when: false

# Clone repository to a temporary directory
- name: Clone the repository to temp dir
  git:
    repo: "{{ kindle_repo_url }}"
    dest: /tmp/kindle-repo
    version: "{{ kindle_repo_branch | default('main') }}"
    key_file: /opt/keys/deploy_key
    accept_hostkey: yes
  register: git_clone

# Move repo contents to final destination
- name: Move repository to destination
  shell: |
    # Delete existing directory contents (but not the directory itself)
    rm -rf /opt/kindle-automator/*
    rm -rf /opt/kindle-automator/.* 2>/dev/null || true

    # Copy from temp repo to destination
    cp -R /tmp/kindle-repo/. /opt/kindle-automator/

    # Restore venv folder if it was backed up
    if [ -d /tmp/kindle-temp/venv ]; then
      rm -rf /opt/kindle-automator/venv 2>/dev/null || true
      mv /tmp/kindle-temp/venv /opt/kindle-automator/
    fi

    # Clean up
    rm -rf /tmp/kindle-repo
    rm -rf /tmp/kindle-temp
  changed_when: true

# Restore .env.prod if backup exists
- name: Restore .env.prod
  shell: |
    if [ -f /tmp/.env.prod.backup ]; then
      cp /tmp/.env.prod.backup /opt/kindle-automator/.env.prod
      rm /tmp/.env.prod.backup
    fi
  changed_when: false

# Set up Python virtual environment
- name: Create Python virtual environment
  command: python3 -m venv /opt/kindle-automator/venv
  args:
    creates: /opt/kindle-automator/venv/bin/activate

# Install uv package manager
- name: Install uv package manager
  pip:
    name: uv
    executable: /opt/kindle-automator/venv/bin/pip
    state: present

# Install dependencies
- name: Install Python dependencies
  shell: |
    source /opt/kindle-automator/venv/bin/activate
    cd /opt/kindle-automator
    uv pip install -r requirements.txt
  args:
    executable: /bin/bash
  tags: deps

# Create logs directories
- name: Create logs directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - /opt/kindle-automator/logs
    - /opt/kindle-automator/logs/appium_logs
    - /opt/kindle-automator/logs/email_logs

# Create screenshots directory
- name: Create screenshots directory
  file:
    path: /opt/kindle-automator/screenshots
    state: directory
    mode: "0755"

# Install Appium globally
- name: Install Appium globally
  npm:
    name: appium
    global: yes
    state: present

# Install Appium UiAutomator2 driver
- name: Install Appium UiAutomator2 driver
  command: npx appium driver install uiautomator2
  args:
    creates: /usr/local/lib/node_modules/appium/node_modules/appium-uiautomator2-driver
  register: uiautomator2_installed
  ignore_errors: yes
  changed_when: false

# Create systemd service file
- name: Create systemd service file
  template:
    src: kindle-automator.service.j2
    dest: /etc/systemd/system/kindle-automator.service
    mode: "0644"
  notify: restart kindle-automator
  tags: systemd

# Enable and start the service
- name: Enable and start kindle-automator service
  systemd:
    name: kindle-automator
    enabled: yes
    state: started
    daemon_reload: yes

# Create scripts directory
- name: Create scripts directory
  file:
    path: /opt/kindle-automator/scripts
    state: directory
    mode: "0755"

# Configure logrotate for all Kindle Automator logs
- name: Configure logrotate for Kindle Automator logs
  template:
    src: logrotate-kindle-automator.j2
    dest: /etc/logrotate.d/kindle-automator
    mode: "0644"
  tags: logrotate
