---
# Install required system packages
- name: Install required packages
  apt:
    name:
      - git
      - python3
      - python3-pip
      - python3-venv
      - libffi-dev
      - libssl-dev
      - build-essential
      - nodejs
      - npm
      - unzip
    state: present
    update_cache: yes

# Create app directory
- name: Create application directory
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - /opt/keys

# Create public deploy key for GitHub
- name: Copy public deploy key for GitHub
  copy:
    src: files/deploy_key
    dest: /opt/keys/deploy_key
    mode: "0400"
  register: deploy_key

# Clone or update the repository
- name: Clone or update the repository
  git:
    repo: "{{ kindle_repo_url }}"
    dest: /opt/kindle-automator
    version: "{{ kindle_repo_branch | default('main') }}"
    update: yes
    force: yes
    key_file: /opt/keys/deploy_key
    accept_hostkey: yes
  register: git_clone

# Set up Python virtual environment
- name: Create Python virtual environment
  command: python3 -m venv /opt/kindle-automator/venv
  args:
    creates: /opt/kindle-automator/venv/bin/activate

# Install uv package manager
- name: Install uv package manager
  pip:
    name: uv
    executable: /opt/kindle-automator/venv/bin/pip
    state: present

# Install dependencies
- name: Install Python dependencies
  shell: |
    source /opt/kindle-automator/venv/bin/activate
    cd /opt/kindle-automator
    uv pip install -r requirements.txt
  args:
    executable: /bin/bash

# Create logs directory
- name: Create logs directory
  file:
    path: /opt/kindle-automator/logs
    state: directory
    mode: "0755"

# Create screenshots directory
- name: Create screenshots directory
  file:
    path: /opt/kindle-automator/screenshots
    state: directory
    mode: "0755"

# Install Appium globally
- name: Install Appium globally
  npm:
    name: appium
    global: yes
    state: present

# Install Appium UiAutomator2 driver
- name: Install Appium UiAutomator2 driver
  command: npx appium driver install uiautomator2
  args:
    creates: /usr/local/lib/node_modules/appium/node_modules/appium-uiautomator2-driver

# Create systemd service file
- name: Create systemd service file
  template:
    src: kindle-automator.service.j2
    dest: /etc/systemd/system/kindle-automator.service
    mode: "0644"
  notify: restart kindle-automator

# Enable and start the service
- name: Enable and start kindle-automator service
  systemd:
    name: kindle-automator
    enabled: yes
    state: started
    daemon_reload: yes
