---
# Install required system packages
- name: Install required packages
  apt:
    name:
      - git
      - python3
      - python3-pip
      - python3-venv
      - libffi-dev
      - libssl-dev
      - build-essential
      - nodejs
      - npm
      - unzip
    state: present
    update_cache: yes

# Create app directory
- name: Create application directory
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - /opt/keys

# Copy environment files
- name: Copy .env.prod to /opt/kindle-automator/.env.prod
  copy:
    src: ../../../../.env.prod
    dest: /opt/kindle-automator/.env.prod
    owner: root
    group: root
    mode: 0644
  when: "'staging' not in inventory_hostname"

- name: Copy .env.staging to /opt/kindle-automator/.env.staging
  copy:
    src: ../../../../.env.staging
    dest: /opt/kindle-automator/.env.staging
    owner: root
    group: root
    mode: 0644
  when: "'staging' in inventory_hostname"

# Create public deploy key for GitHub
- name: Copy public deploy key for GitHub
  copy:
    src: files/deploy_key
    dest: /opt/keys/deploy_key
    mode: "0400"
  register: deploy_key

# Ensure repository directory exists
- name: Create repository directory
  file:
    path: /opt/kindle-automator
    state: directory
    mode: "0755"

# Check if repository exists
- name: Check if repository exists
  stat:
    path: /opt/kindle-automator/.git
  register: repo_exists

# Clone repository if it doesn't exist
- name: Clone repository if not present
  git:
    repo: "{{ kindle_repo_url }}"
    dest: /opt/kindle-automator
    version: "{{ kindle_repo_branch | default('main') }}"
    key_file: /opt/keys/deploy_key
    accept_hostkey: yes
  when: not repo_exists.stat.exists

# Check if uv is already installed
- name: Check if uv exists
  stat:
    path: /usr/local/bin/uv
  register: uv_exists

# Install uv package manager globally
- name: Download and install uv
  shell: |
    curl -LsSf https://astral.sh/uv/install.sh | sh
  args:
    creates: /root/.cargo/bin/uv
  when: not uv_exists.stat.exists

# Add uv to system PATH
- name: Create uv symlink in /usr/local/bin
  file:
    src: /root/.cargo/bin/uv
    dest: /usr/local/bin/uv
    state: link
  when: not uv_exists.stat.exists

# Pull latest changes
- name: Pull latest changes
  git:
    repo: "{{ kindle_repo_url }}"
    dest: /opt/kindle-automator
    update: yes
    version: "{{ kindle_repo_branch | default('main') }}"
    key_file: /opt/keys/deploy_key
    accept_hostkey: yes
  register: git_pull
  tags: deps, pull

# Install dependencies using uv
- name: Install Python dependencies
  shell: |
    cd /opt/kindle-automator
    uv pip install --system -r requirements.txt
  args:
    executable: /bin/bash
  tags: deps

# Create logs directories
- name: Create logs directories
  file:
    path: "{{ item }}"
    state: directory
    mode: "0755"
  with_items:
    - /opt/kindle-automator/logs
    - /opt/kindle-automator/logs/appium_logs
    - /opt/kindle-automator/logs/email_logs

# Create screenshots directory
- name: Create screenshots directory
  file:
    path: /opt/kindle-automator/screenshots
    state: directory
    mode: "0755"

# Install Appium globally
- name: Install Appium globally
  npm:
    name: appium
    global: yes
    state: present

# Create systemd service file
- name: Create systemd service file
  template:
    src: kindle-automator.service.j2
    dest: /etc/systemd/system/kindle-automator.service
    mode: "0644"
  notify: restart kindle-automator
  tags: systemd

# Enable and start the service
- name: Enable and start kindle-automator service
  systemd:
    name: kindle-automator
    enabled: yes
    state: started
    daemon_reload: yes

# Create scripts directory
- name: Create scripts directory
  file:
    path: /opt/kindle-automator/scripts
    state: directory
    mode: "0755"

# Configure logrotate for all Kindle Automator logs
- name: Configure logrotate for Kindle Automator logs
  template:
    src: logrotate-kindle-automator.j2
    dest: /etc/logrotate.d/kindle-automator
    mode: "0644"
  tags: logrotate

# Disable apport crash reporting to prevent dialog popups
- name: Check if apport is installed
  stat:
    path: /etc/default/apport
  register: apport_config

- name: Disable apport crash reporting
  lineinfile:
    path: /etc/default/apport
    regexp: "^enabled="
    line: "enabled=0"
    backrefs: yes
  when: apport_config.stat.exists
  notify: stop apport
# No continuous monitoring - crash dialogs will be handled during emulator launch
