---
- name: Ensure required dependencies are installed (Ubuntu ARM)
  apt:
    name:
      - unzip
      - qemu-kvm
      - libvirt-daemon-system
      - libvirt-clients
      - python3-libvirt
      - bridge-utils
      - libglu-dev
      - default-jdk
    state: present
    update_cache: yes
  become: yes

- name: Set $PATH for Android SDK
  lineinfile:
    path: ~/.zshrc
    line: "export PATH=$PATH:{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator"
    create: yes
  become: yes

- name: Set ANDROID_HOME
  lineinfile:
    path: ~/.zshrc
    line: "export ANDROID_HOME={{ android_home }}"
    create: yes
  become: yes

- name: Set ANDROID_SDK_ROOT
  lineinfile:
    path: ~/.zshrc
    line: "export ANDROID_SDK_ROOT={{ android_home }}"
    create: yes
  become: yes

- name: Create Android SDK directory
  file:
    path: "{{ android_home }}"
    state: directory
    mode: "0755"
  become: yes

- name: Download command line tools
  get_url:
    url: "{{ sdk_tools_url }}"
    dest: "/tmp/cmdline-tools.zip"
  become: yes

- name: Unzip command line tools into SDK folder
  unarchive:
    src: "/tmp/cmdline-tools.zip"
    dest: "{{ android_home }}"
    remote_src: yes
  become: yes

- name: Move/rename command line tools folder
  command: mv "{{ android_home }}/cmdline-tools" "{{ android_home }}/cmdline-tools-latest"
  become: yes
  args:
    creates: "{{ android_home }}/cmdline-tools-latest"

- name: Create cmdline-tools folder structure
  file:
    path: "{{ android_home }}/cmdline-tools/latest"
    state: directory
    mode: "0755"
  become: yes

- name: List directory contents for debugging
  shell: ls -la {{ android_home }}/cmdline-tools-latest/
  register: dir_contents
  become: yes

# - name: Debug directory contents
#   debug:
#     var: dir_contents.stdout_lines

- name: Move all content under cmdline-tools-latest to the 'latest' folder
  shell: "cp -r {{ android_home }}/cmdline-tools-latest/. {{ android_home }}/cmdline-tools/latest/ && rm -rf {{ android_home }}/cmdline-tools-latest"
  become: yes

- name: Set ANDROID_HOME environment variable for all users
  lineinfile:
    path: /etc/profile
    line: "export ANDROID_HOME={{ android_home }}"
    create: yes
  become: yes

- name: Add Android SDK tools to PATH
  lineinfile:
    path: /etc/profile
    line: "export PATH=$PATH:{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator"
    create: yes
  become: yes

- name: Refresh environment variables
  shell: . /etc/profile
  become: yes

##
# Install SDK packages via sdkmanager
##
- name: Accept all Android SDK licenses
  shell: |
    yes | {{ android_home }}/cmdline-tools/latest/bin/sdkmanager --licenses
  args:
    chdir: "{{ android_home }}"
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"

- name: Install platform-tools
  shell: >
    {{ android_home }}/cmdline-tools/latest/bin/sdkmanager
    "{{ platform_tools_package }}"
  args:
    chdir: "{{ android_home }}"
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"

- name: Install platforms
  shell: >
    {{ android_home }}/cmdline-tools/latest/bin/sdkmanager
    "platforms;android-{{ sdk_api_level }}"
  args:
    chdir: "{{ android_home }}"
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"

- name: Install emulator
  shell: >
    {{ android_home }}/cmdline-tools/latest/bin/sdkmanager
    "{{ emulator_package }}"
  args:
    chdir: "{{ android_home }}"
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"

- name: Install build-tools
  shell: >
    {{ android_home }}/cmdline-tools/latest/bin/sdkmanager
    "{{ build_tools_package }}"
  args:
    chdir: "{{ android_home }}"
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"

- name: Install system image (Google APIs for API {{ sdk_api_level }})
  shell: >
    {{ android_home }}/cmdline-tools/latest/bin/sdkmanager
    "{{ sys_img }}"
  args:
    chdir: "{{ android_home }}"
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"
##
# Create an AVD
##
- name: Create the AVD (if not exists)
  shell: >
    echo "no" |
    {{ android_home }}/cmdline-tools/latest/bin/avdmanager create avd
    --name {{ avd_name }}
    --package "{{ sys_img }}"
    --device "{{ device_skin }}"
    --sdcard {{ sdcard_size }}
    --force
  args:
    creates: "{{ android_home }}/.android/avd/{{ avd_name }}.avd"
  become: yes
  environment:
    ANDROID_SDK_ROOT: "{{ android_home }}"
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/cmdline-tools/latest/bin:{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"

##
# Manage emulator process
##
- name: Get running emulator processes
  shell: pgrep -f qemu-system-x86_64-headless
  register: emulator_check
  ignore_errors: yes
  become: yes

- name: Kill existing emulator if running
  shell: "kill {{ item }}"
  with_items: "{{ emulator_check.stdout_lines | default([]) }}"
  ignore_errors: yes
  become: yes
  when: emulator_check.stdout_lines is defined

- name: Stop existing ADB server
  command: adb kill-server
  ignore_errors: yes
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/platform-tools:{{ ansible_env.PATH }}"

- name: Start ADB server
  command: adb start-server
  become: yes
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/platform-tools:{{ ansible_env.PATH }}"

- name: Check emulator status
  shell: "{{ android_home }}/platform-tools/adb devices | grep emulator | wc -l"
  register: emulator_status
  changed_when: false

- name: Start the emulator in background
  shell: |
    {{ android_home }}/emulator/emulator \
      -avd {{ avd_name }} \
      -no-window \
      -no-audio \
      -no-boot-anim \
      -gpu guest \
      -memory 2048 \
      -cores 2 \
      -verbose &
  args:
    chdir: "{{ android_home }}"
  environment:
    ANDROID_HOME: "{{ android_home }}"
    ANDROID_AVD_HOME: "{{ android_home }}/.android/avd"
    PATH: "{{ android_home }}/platform-tools:{{ android_home }}/emulator:{{ ansible_env.PATH }}"
  become: yes
  when: emulator_status.stdout | int == 0

- name: Wait for emulator to boot
  shell: |
    {{ android_home }}/platform-tools/adb wait-for-device shell '
      while [ "$(getprop sys.boot_completed)" != "1" ]; do
        sleep 2;
      done'
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/platform-tools:{{ ansible_env.PATH }}"
  when: emulator_status.stdout | int == 0

##
# Install and launch Kindle
##
- name: Check if Kindle is installed
  shell: "{{ android_home }}/platform-tools/adb shell pm list packages | grep com.amazon.kindle"
  register: kindle_installed
  ignore_errors: yes
  changed_when: false

- name: Upload and install Kindle APK
  block:
    - name: Upload the Kindle APK to remote
      copy:
        src: "{{ kindle_package_path }}"
        dest: "/tmp/Kindle.apk"
      become: yes

    - name: Install Kindle APK
      shell: >
        {{ android_home }}/platform-tools/adb install -r /tmp/Kindle.apk
      environment:
        ANDROID_HOME: "{{ android_home }}"
        PATH: "{{ android_home }}/platform-tools:{{ ansible_env.PATH }}"
  when: kindle_installed.rc != 0

- name: Launch Kindle
  shell: >
    {{ android_home }}/platform-tools/adb shell monkey -p com.amazon.kindle 1
  environment:
    ANDROID_HOME: "{{ android_home }}"
    PATH: "{{ android_home }}/platform-tools:{{ ansible_env.PATH }}"
