---
# Include firewall configuration
- include_tasks: firewall.yml
  tags: [postgres, firewall]

- name: Create PostgreSQL base directory
  file:
    path: /opt/postgres
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create PostgreSQL data directory
  file:
    path: /opt/postgres/data
    state: directory
    owner: "999"
    group: "999"
    mode: '0700'

- name: Check if PostgreSQL data directory is initialized
  stat:
    path: /opt/postgres/data/PG_VERSION
  register: pg_initialized

- name: Clean data directory if not initialized
  shell: rm -rf /opt/postgres/data/*
  when: not pg_initialized.stat.exists

- name: Ensure PostgreSQL data directory permissions
  command: chown -R 999:999 /opt/postgres/data
  changed_when: false

- name: Create PostgreSQL docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: /opt/postgres/docker-compose.yml
    owner: root
    group: root
    mode: '0644'
  notify: restart postgres

- name: Create PostgreSQL init script
  template:
    src: init-db.sql.j2
    dest: /opt/postgres/init-db.sql
    owner: root
    group: root
    mode: '0644'
  notify: restart postgres

- name: Start PostgreSQL container
  community.docker.docker_compose_v2:
    project_src: /opt/postgres
    state: present
  register: postgres_started

- name: Check PostgreSQL container status
  command: docker ps -a --filter "name=kindle_automator_postgres" --format "{% raw %}table {{.Status}}{% endraw %}"
  register: container_status
  changed_when: false

- name: Get PostgreSQL container logs if not running
  command: docker logs kindle_automator_postgres --tail 50
  register: container_logs
  when: "'Up' not in container_status.stdout"
  failed_when: false

- name: Display container logs if available
  debug:
    var: container_logs.stdout_lines
  when: container_logs is defined and container_logs.stdout_lines is defined

- name: Wait for PostgreSQL to be ready
  wait_for:
    port: 5432
    host: localhost
    delay: 5
    timeout: 60

# Firewall configuration is now handled in firewall.yml