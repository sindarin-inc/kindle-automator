---
- name: Install iptables-persistent
  apt:
    name: iptables-persistent
    state: present
  when: ansible_os_family == "Debian"

- name: Create PostgreSQL base directory
  file:
    path: /opt/postgres
    state: directory
    owner: root
    group: root
    mode: '0755'

- name: Create PostgreSQL data directory
  file:
    path: /opt/postgres/data
    state: directory
    owner: "999"
    group: "999"
    mode: '0700'

- name: Check if PostgreSQL data directory is initialized
  stat:
    path: /opt/postgres/data/PG_VERSION
  register: pg_initialized

- name: Clean data directory if not initialized
  shell: rm -rf /opt/postgres/data/*
  when: not pg_initialized.stat.exists

- name: Ensure PostgreSQL data directory permissions
  command: chown -R 999:999 /opt/postgres/data
  changed_when: false

- name: Create PostgreSQL docker-compose file
  template:
    src: docker-compose.yml.j2
    dest: /opt/postgres/docker-compose.yml
    owner: root
    group: root
    mode: '0644'
  notify: restart postgres

- name: Create PostgreSQL init script
  template:
    src: init-db.sql.j2
    dest: /opt/postgres/init-db.sql
    owner: root
    group: root
    mode: '0644'
  notify: restart postgres

- name: Start PostgreSQL container
  community.docker.docker_compose_v2:
    project_src: /opt/postgres
    state: present
  register: postgres_started

- name: Check PostgreSQL container status
  command: docker ps -a --filter "name=kindle_automator_postgres" --format "{% raw %}table {{.Status}}{% endraw %}"
  register: container_status
  changed_when: false

- name: Get PostgreSQL container logs if not running
  command: docker logs kindle_automator_postgres --tail 50
  register: container_logs
  when: "'Up' not in container_status.stdout"
  failed_when: false

- name: Display container logs if available
  debug:
    var: container_logs.stdout_lines
  when: container_logs is defined and container_logs.stdout_lines is defined

- name: Wait for PostgreSQL to be ready
  wait_for:
    port: 5432
    host: localhost
    delay: 5
    timeout: 60

- name: Configure Docker firewall rules for PostgreSQL
  block:
    - name: Build list of allowed IPs from inventory
      set_fact:
        postgres_allowed_ips: >-
          {{
            ['127.0.0.1'] +
            groups['prod'] | map('extract', hostvars, 'ansible_host') | list +
            groups['staging'] | map('extract', hostvars, 'ansible_host') | list
          }}

    - name: Allow PostgreSQL from authorized servers
      iptables:
        chain: DOCKER-USER
        protocol: tcp
        source: "{{ item }}"
        destination_port: 5432
        jump: RETURN
        comment: "Allow PostgreSQL from {{ item }}"
        state: present
      loop: "{{ postgres_allowed_ips }}"

    - name: Block all other PostgreSQL connections
      iptables:
        chain: DOCKER-USER
        protocol: tcp
        destination_port: 5432
        jump: DROP
        comment: "Block all other PostgreSQL connections"
        state: present

    - name: Save iptables rules
      shell: |
        if command -v netfilter-persistent > /dev/null; then
          netfilter-persistent save
        elif command -v iptables-save > /dev/null; then
          iptables-save > /etc/iptables/rules.v4
        fi
      changed_when: false