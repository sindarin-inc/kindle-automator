name: API Tests

on:
  workflow_dispatch:
    inputs:
      test_type:
        description: 'Type of test to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - init
          - auth
          - books
          - navigate
          - style
          - fixtures

jobs:
  api-test:
    runs-on: ubuntu-latest
    
    services:
      # Note: This workflow is designed to run against a deployed instance
      # For local testing, the server and emulator need to be running
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests
    
    - name: Wait for server
      run: |
        echo "Note: This workflow expects the server to be running at the target URL"
        echo "Modify SERVER_URL in the workflow or use against a deployed instance"
      env:
        SERVER_URL: ${{ secrets.SERVER_URL || 'http://localhost:4098' }}
    
    - name: Run all tests
      if: github.event.inputs.test_type == 'all'
      run: |
        make test-init || true
        make test-auth EMAIL=${{ secrets.TEST_EMAIL }} PASSWORD=${{ secrets.TEST_PASSWORD }} || true
        make test-books EMAIL=${{ secrets.TEST_EMAIL }} || true
        make test-navigate EMAIL=${{ secrets.TEST_EMAIL }} || true
        make test-style EMAIL=${{ secrets.TEST_EMAIL }} || true
        make test-fixtures EMAIL=${{ secrets.TEST_EMAIL }} || true
    
    - name: Run specific test
      if: github.event.inputs.test_type != 'all'
      run: |
        case "${{ github.event.inputs.test_type }}" in
          init) make test-init ;;
          auth) make test-auth EMAIL=${{ secrets.TEST_EMAIL }} PASSWORD=${{ secrets.TEST_PASSWORD }} ;;
          books) make test-books EMAIL=${{ secrets.TEST_EMAIL }} ;;
          navigate) make test-navigate EMAIL=${{ secrets.TEST_EMAIL }} ;;
          style) make test-style EMAIL=${{ secrets.TEST_EMAIL }} ;;
          fixtures) make test-fixtures EMAIL=${{ secrets.TEST_EMAIL }} ;;
        esac